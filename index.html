<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Okullar • Yakınlık + Google Static Map</title>

  <!-- Leaflet (interaktif harita için) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --muted:#a8b3cf; --text:#e9efff; --accent:#7aa2ff; --border:#23304d; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:18px 18px 12px; border-bottom:1px solid var(--border); }
    h1 { margin:0; font-size:18px; }
    .sub { margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }
    .layout { display:grid; grid-template-columns: 520px 1fr; gap:12px; height: calc(100vh - 132px); }
    @media (max-width: 980px) { .layout { grid-template-columns: 1fr; height:auto; } #map { height: 55vh; } }
    .panel { padding:12px; overflow:auto; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin-bottom:10px; }
    .row { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .title { font-weight:700; font-size:14px; }
    .meta { color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    button { background:transparent; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600; font-size:12px; }
    button:hover { border-color: var(--accent); }
    button.primary { background: rgba(122,162,255,.12); border-color: rgba(122,162,255,.35); }
    button.danger { border-color: rgba(255,120,120,.35); background: rgba(255,120,120,.10); }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .input { width:100%; box-sizing:border-box; margin-top:10px; background:#0f1730; border:1px solid var(--border); color:var(--text); padding:9px 10px; border-radius:10px; font-size:12px; }
    .hint { margin-top:8px; color:var(--muted); font-size:12px; }
    .topbar { display:flex; gap:10px; align-items:center; margin: 12px; flex-wrap:wrap; }
    .search { flex:1; min-width: 240px; }
    #map { height:100%; width:100%; border-left:1px solid var(--border); }
    .badge { font-size:11px; color: var(--muted); border:1px solid var(--border); padding:4px 8px; border-radius:999px; white-space:nowrap; }
    .status { margin: 0 12px 12px; color: var(--muted); font-size: 12px; line-height:1.35; }
    .km { font-weight:700; color: var(--text); }
    .small { font-size:11px; color: var(--muted); margin-top: 6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    img.mapimg { width:100%; border-radius:12px; border:1px solid var(--border); margin-top:8px; display:block; }
  </style>
</head>

<body>
  <header>
    <h1>Okullar (İmam Hatip Hariç) • Yakınlık + Google Static Map</h1>
    <div class="sub">
   
      <span class="small">Not: Mesafe “kuş uçuşu (km)”.</span>
    </div>
  </header>

  <div class="topbar">
    <input id="filter" class="input search" placeholder="Ara: okul adı / ilçe (örn: Maltepe, Kadıköy...)">
    <button id="btnGeocodeAll" class="primary">Toplu Konum Bul</button>
    <button id="btnShowAll" class="primary">Hepsini Haritada Göster</button>
    <button id="clearMarkers">Haritayı Temizle</button>
    <button id="clearCache" class="danger">Cache Sıfırla</button>
  </div>

  <div class="status" id="status">Hazır.</div>

  <div class="layout">
    <div class="panel" id="list"></div>
    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /***********************
     * 0) GOOGLE STATIC MAPS AYARLARI
     ***********************/
    const GOOGLE_MAPS_API_KEY = "AIzaSyDjrjb-aYP3CAFffI31Uorm2i1ICB8naUA";
    // Not: Key'i güvenli tutmak için normalde backend önerilir. Bu demo "tek dosya" olduğu için front-end'de.

    /***********************
     * 1) EV KONUMU (KOORDİNAT - EN GARANTİ)
     * Google Maps'ten "Burada ne var?" ile alıp buraya yapıştır.
     ***********************/
    const HOME_COORD = { lat: 40.9329, lon: 29.1418, label: "Ev Konumu (Feyzullah / Sevinç Sk.)" };
    // ↑ BURAYI KENDİ KOORDİNATINLA GÜNCELLE (en doğrusu)

    /***********************
     * 2) OKUL VERİSİ
     ***********************/
    const schools = [
      // MALTEPE
      { id: "maltepe_adnan_kahveci", district: "Maltepe", name: "Adnan Kahveci Ortaokulu", address: "Adnan Kahveci Ortaokulu, Maltepe, İstanbul" },
      { id: "maltepe_celal_avsar", district: "Maltepe", name: "Celal Avşar Ortaokulu", address: "Celal Avşar Ortaokulu, Maltepe, İstanbul" },
      { id: "maltepe_kucukyali_mtal", district: "Maltepe", name: "Küçükyalı Mesleki ve Teknik Anadolu Lisesi", address: "Küçükyalı Mesleki ve Teknik Anadolu Lisesi, Maltepe, İstanbul" },
      { id: "maltepe_muhsine_zeynep", district: "Maltepe", name: "Muhsine Zeynep Ortaokulu", address: "Muhsine Zeynep Ortaokulu, Maltepe, İstanbul" },
      { id: "maltepe_mutluhan_uzunal_colakoglu", district: "Maltepe", name: "Mutluhan-Uzunal-Çolakoğlu Ortaokulu", address: "Mutluhan-Uzunal-Çolakoğlu Ortaokulu, Maltepe, İstanbul" },
      { id: "maltepe_suzan_ahmet_yalkin", district: "Maltepe", name: "Suzan Ahmet Yalkın Ortaokulu", address: "Suzan Ahmet Yalkın Ortaokulu, Maltepe, İstanbul" },
      { id: "maltepe_toki_anadolu", district: "Maltepe", name: "TOKİ Maltepe Anadolu Lisesi", address: "TOKİ Maltepe Anadolu Lisesi, Maltepe, İstanbul" },
      { id: "maltepe_zumrutevler_anadolu", district: "Maltepe", name: "Zümrütevler Anadolu Lisesi", address: "Zümrütevler Anadolu Lisesi, Maltepe, İstanbul" },

      // KADIKÖY
      { id: "kadikoy_bahariye", district: "Kadıköy", name: "Bahariye Ortaokulu", address: "Bahariye Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_bostanci_ataturk", district: "Kadıköy", name: "Bostancı Atatürk Ortaokulu", address: "Bostancı Atatürk Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_cenap_sahabettin", district: "Kadıköy", name: "Cenap Şahabettin İlkokulu", address: "Cenap Şahabettin İlkokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_faik_resit_unat", district: "Kadıköy", name: "Faik Reşit Unat Ortaokulu", address: "Faik Reşit Unat Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_halil_turkan", district: "Kadıköy", name: "Halil Türkan Ortaokulu", address: "Halil Türkan Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_ikbaliye", district: "Kadıköy", name: "İkbaliye Ortaokulu", address: "İkbaliye Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_ilhami_ertem", district: "Kadıköy", name: "İlhami Ertem Ortaokulu", address: "İlhami Ertem Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_avni_akyol_gsl", district: "Kadıköy", name: "İstanbul Avni Akyol Güzel Sanatlar Lisesi", address: "İstanbul Avni Akyol Güzel Sanatlar Lisesi, Kadıköy, İstanbul" },
      { id: "kadikoy_spor_lisesi", district: "Kadıköy", name: "Kadıköy Spor Lisesi", address: "Kadıköy Spor Lisesi, Kadıköy, İstanbul" },
      { id: "kadikoy_resat_nuri", district: "Kadıköy", name: "Reşat Nuri Güntekin Ortaokulu", address: "Reşat Nuri Güntekin Ortaokulu, Kadıköy, İstanbul" },

      // KARTAL
      { id: "kartal_100yil_ali_riza", district: "Kartal", name: "100 Yıl Ali Rıza Efendi Ortaokulu", address: "100 Yıl Ali Rıza Efendi Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_cevizli", district: "Kartal", name: "Cevizli Ortaokulu", address: "Cevizli Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_cavusoglu", district: "Kartal", name: "Çavuşoğlu Ortaokulu", address: "Çavuşoğlu Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_ibrahim_saime_zipkin", district: "Kartal", name: "İbrahim Saime Zıpkın İlkokulu", address: "İbrahim Saime Zıpkın İlkokulu, Kartal, İstanbul" },
      { id: "kartal_ihsan_zakiroglu", district: "Kartal", name: "İhsan Zakiroğlu Ortaokulu", address: "İhsan Zakiroğlu Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_borsa_istanbul_mtal", district: "Kartal", name: "Kartal Borsa İstanbul Mesleki ve Teknik Anadolu Lisesi", address: "Kartal Borsa İstanbul Mesleki ve Teknik Anadolu Lisesi, Kartal, İstanbul" },
      { id: "kartal_mev_ortaokulu", district: "Kartal", name: "Kartal Milli Eğitim Vakfı Ortaokulu", address: "Kartal Milli Eğitim Vakfı Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_sehit_er_serhat_sanli", district: "Kartal", name: "Şehit Er Serhat Şanlı Ortaokulu", address: "Şehit Er Serhat Şanlı Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_sehit_timur_aktemur", district: "Kartal", name: "Şehit Timur Aktemur Ortaokulu", address: "Şehit Timur Aktemur Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_toki_sehit_mustafa", district: "Kartal", name: "TOKİ Şehit Mustafa Kartal Ortaokulu", address: "TOKİ Şehit Mustafa Kartal Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_ulku_bora", district: "Kartal", name: "Ülkü Bora Ortaokulu", address: "Ülkü Bora Ortaokulu, Kartal, İstanbul" },

      // PENDİK
      { id: "pendik_700_yil", district: "Pendik", name: "700. Yıl Ortaokulu", address: "700. Yıl Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_abdullah_acar", district: "Pendik", name: "Abdullah Acar Ortaokulu", address: "Abdullah Acar Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_alparslan_al", district: "Pendik", name: "Alparslan Anadolu Lisesi", address: "Alparslan Anadolu Lisesi, Pendik, İstanbul" },
      { id: "pendik_cahit_zarifoglu", district: "Pendik", name: "Cahit Zarifoğlu Ortaokulu", address: "Cahit Zarifoğlu Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_faruk_demirbag", district: "Pendik", name: "Faruk Demirbağ Ortaokulu", address: "Faruk Demirbağ Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_kazim_karabekir", district: "Pendik", name: "Kazım Karabekir Ortaokulu", address: "Kazım Karabekir Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_mehmet_akif_ersoy", district: "Pendik", name: "Mehmet Akif Ersoy Ortaokulu", address: "Mehmet Akif Ersoy Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_nuri_demirag_mtal", district: "Pendik", name: "Nuri Demirağ Mesleki ve Teknik Anadolu Lisesi", address: "Nuri Demirağ Mesleki ve Teknik Anadolu Lisesi, Pendik, İstanbul" },
      { id: "pendik_orhangazi", district: "Pendik", name: "Orhangazi Ortaokulu", address: "Orhangazi Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_ogretmenevleri", district: "Pendik", name: "Öğretmenevleri Ortaokulu", address: "Öğretmenevleri Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_sehit_selcuk_beki", district: "Pendik", name: "Şehit Selçuk Beki Ortaokulu", address: "Şehit Selçuk Beki Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_seyhli", district: "Pendik", name: "Şeyhli Ortaokulu", address: "Şeyhli Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_velibaba", district: "Pendik", name: "Velibaba Ortaokulu", address: "Velibaba Ortaokulu, Pendik, İstanbul" },
    ];

    /***********************
     * 3) CACHE
     ***********************/
    const CACHE_KEY = "school_geo_cache_v2";
    function loadCache() { try { return JSON.parse(localStorage.getItem(CACHE_KEY) || "{}"); } catch { return {}; } }
    function saveCache(obj) { localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); }
    let geoCache = loadCache(); // { [id]: {lat, lon, display, query, ts} }

    /***********************
     * 4) HARİTA (Leaflet)
     ***********************/
    const map = L.map("map").setView([HOME_COORD.lat, HOME_COORD.lon], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap katkıcıları'
    }).addTo(map);
    const markersLayer = L.layerGroup().addTo(map);

    function setStatus(t) { document.getElementById("status").textContent = t; }

    // Ev marker
    const homeMarker = L.marker([HOME_COORD.lat, HOME_COORD.lon]).addTo(markersLayer);
    homeMarker.bindPopup(`<b>${escapeHtml(HOME_COORD.label)}</b><br><small>${HOME_COORD.lat}, ${HOME_COORD.lon}</small>`);

    /***********************
     * 5) Nominatim ile okul geocode (API key gerekmez)
     ***********************/
    const GEOCODE_DELAY_MS = 900;
    async function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function geocode(query) {
      const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(query);
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("Geocoding failed: " + res.status);
      const data = await res.json();
      if (!data || data.length === 0) return null;
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), display: data[0].display_name };
    }

    async function geocodeSchoolIfNeeded(s, queryOverride) {
      const existing = geoCache[s.id];
      if (existing && typeof existing.lat === "number" && typeof existing.lon === "number") return existing;

      const q = (queryOverride || s.address || `${s.name}, ${s.district}, İstanbul`).trim();
      const found = await geocode(q);
      if (!found) return null;

      const rec = { ...found, query: q, ts: Date.now() };
      geoCache[s.id] = rec;
      saveCache(geoCache);
      return rec;
    }

    /***********************
     * 6) MESAFE (Haversine)
     ***********************/
    function toRad(x){ return x * Math.PI / 180; }
    function haversineKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function computeDistanceKm(s) {
      const rec = geoCache[s.id];
      if (!rec) return null;
      return haversineKm(HOME_COORD.lat, HOME_COORD.lon, rec.lat, rec.lon);
    }

    /***********************
     * 7) GOOGLE STATIC MAP
     ***********************/
    function getGoogleStaticMapUrl(lat, lon, zoom=16, w=640, h=320) {
      // Not: scale=2 daha net görüntü
      const base = "https://maps.googleapis.com/maps/api/staticmap";
      const center = `center=${lat},${lon}`;
      const size = `size=${w}x${h}`;
      const z = `zoom=${zoom}`;
      const scale = "scale=2";
      const marker = `markers=color:red%7C${lat},${lon}`;
      const key = `key=${encodeURIComponent(GOOGLE_MAPS_API_KEY)}`;
      return `${base}?${center}&${z}&${size}&${scale}&${marker}&${key}`;
    }

    function getGoogleMapsLink(lat, lon) {
      return `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
    }

    /***********************
     * 8) LİSTE / UI
     ***********************/
    const listEl = document.getElementById("list");
    const filterEl = document.getElementById("filter");

    function getFilteredSchools() {
      const q = (filterEl.value || "").toLowerCase().trim();
      return schools.filter(s => ((s.name + " " + s.district).toLowerCase().includes(q) || !q));
    }

    function render() {
      const filtered = getFilteredSchools();
      const arr = filtered.map(s => ({ s, d: computeDistanceKm(s) }));

      arr.sort((a,b) => {
        const ad = (typeof a.d === "number") ? a.d : Infinity;
        const bd = (typeof b.d === "number") ? b.d : Infinity;
        if (ad !== bd) return ad - bd;
        return a.s.name.localeCompare(b.s.name, "tr");
      });

      listEl.innerHTML = "";
      if (arr.length === 0) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.textContent = "Eşleşen okul yok.";
        listEl.appendChild(empty);
        return;
      }

      for (const {s, d} of arr) listEl.appendChild(createSchoolCard(s, d));
    }

    function createSchoolCard(s, distKm) {
      const card = document.createElement("div");
      card.className = "card";

      const distLabel = (typeof distKm === "number") ? `${distKm.toFixed(2)} km` : "—";

      const top = document.createElement("div");
      top.className = "row";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="title">${escapeHtml(s.name)}</div>
        <div class="meta">
          <span class="badge">${escapeHtml(s.district)}</span>
          <span class="badge">Mesafe: <span class="km">${escapeHtml(distLabel)}</span></span>
        </div>
      `;

      const right = document.createElement("div");
      right.innerHTML = `<span class="badge">Google Static</span>`;

      top.appendChild(left);
      top.appendChild(right);

      const addrInput = document.createElement("input");
      addrInput.className = "input";
      addrInput.value = s.address;
      addrInput.placeholder = "Konum/Adres (gerekirse mahalle/sokak ekle)";
      addrInput.setAttribute("data-school-id", s.id);

      const controls = document.createElement("div");
      controls.className = "controls";

      const btnFind = document.createElement("button");
      btnFind.className = "primary";
      btnFind.textContent = "Konumu Bul + Resmi Göster";

      const btnShowLeaflet = document.createElement("button");
      btnShowLeaflet.textContent = "Interaktif Haritada Göster";

      const btnClearThis = document.createElement("button");
      btnClearThis.textContent = "Bu Okulu Cache'den Sil";

      const preview = document.createElement("div");
      preview.setAttribute("data-preview", s.id);

      // Cache varsa önizleme otomatik
      const cached = geoCache[s.id];
      if (cached) {
        preview.innerHTML = buildPreviewHtml(s, cached);
      } else {
        preview.innerHTML = `<div class="small">Önizleme için önce konumu bul.</div>`;
      }

      btnFind.onclick = async () => {
        if (!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY.includes("YOUR_GOOGLE")) {
          setStatus("Google API key eklemen lazım: GOOGLE_MAPS_API_KEY alanını doldur.");
          return;
        }

        const q = addrInput.value.trim();
        if (!q) return;

        setStatus("Konum aranıyor: " + q);
        btnFind.disabled = true;
        btnFind.textContent = "Aranıyor...";

        try {
          const rec = await geocodeSchoolIfNeeded(s, q);
          if (!rec) {
            setStatus("Konum bulunamadı. Adresi daha detaylı yazıp tekrar dene.");
            return;
          }
          preview.innerHTML = buildPreviewHtml(s, rec);
          setStatus("Bulundu: " + s.name);
          render(); // mesafeye göre sıralama güncellensin
        } catch (e) {
          console.error(e);
          setStatus("Hata: Konum aranırken sorun oldu.");
        } finally {
          btnFind.disabled = false;
          btnFind.textContent = "Konumu Bul + Resmi Göster";
        }
      };

      btnShowLeaflet.onclick = async () => {
        const q = addrInput.value.trim();
        if (!q) return;

        setStatus("Haritada göstermek için konum aranıyor: " + q);
        btnShowLeaflet.disabled = true;

        try {
          let rec = geoCache[s.id];
          if (!rec) rec = await geocodeSchoolIfNeeded(s, q);
          if (!rec) {
            setStatus("Konum bulunamadı.");
            return;
          }

          const m = L.marker([rec.lat, rec.lon]).addTo(markersLayer);
          m.bindPopup(`<b>${escapeHtml(s.name)}</b><br><small>${escapeHtml(rec.display || "")}</small>`).openPopup();

          const bounds = L.latLngBounds();
          bounds.extend([HOME_COORD.lat, HOME_COORD.lon]);
          bounds.extend([rec.lat, rec.lon]);
          map.fitBounds(bounds.pad(0.25));

          setStatus("Haritada gösterildi: " + s.name);
        } catch (e) {
          console.error(e);
          setStatus("Hata oluştu.");
        } finally {
          btnShowLeaflet.disabled = false;
        }
      };

      btnClearThis.onclick = () => {
        delete geoCache[s.id];
        saveCache(geoCache);
        setStatus("Cache silindi: " + s.name);
        render();
      };

      controls.appendChild(btnFind);
      controls.appendChild(btnShowLeaflet);
      controls.appendChild(btnClearThis);

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "İpucu: Konum yanlış çıkarsa adres alanına mahalle/sokak ekleyip tekrar dene.";

      card.appendChild(top);
      card.appendChild(addrInput);
      card.appendChild(controls);
      card.appendChild(preview);
      card.appendChild(hint);

      return card;
    }

    function buildPreviewHtml(s, rec) {
      const km = haversineKm(HOME_COORD.lat, HOME_COORD.lon, rec.lat, rec.lon).toFixed(2);
      const imgUrl = getGoogleStaticMapUrl(rec.lat, rec.lon, 16, 640, 320);
      const link = getGoogleMapsLink(rec.lat, rec.lon);

      return `
        <a href="${link}" target="_blank" rel="noopener">
          <img class="mapimg" src="${imgUrl}" alt="Harita: ${escapeHtml(s.name)}">
        </a>
        <div class="small">
          <b>Mesafe:</b> ${escapeHtml(km)} km •
          <span class="mono">${escapeHtml(rec.lat)}, ${escapeHtml(rec.lon)}</span><br>
          <span>${escapeHtml(rec.display || "")}</span>
        </div>
      `;
    }

    /***********************
     * 9) TOP BAR BUTONLARI
     ***********************/
    filterEl.addEventListener("input", render);

    document.getElementById("clearMarkers").onclick = () => {
      markersLayer.clearLayers();
      // ev marker'ı geri ekle
      const hm = L.marker([HOME_COORD.lat, HOME_COORD.lon]).addTo(markersLayer);
      hm.bindPopup(`<b>${escapeHtml(HOME_COORD.label)}</b><br><small>${HOME_COORD.lat}, ${HOME_COORD.lon}</small>`);
      setStatus("Harita temizlendi.");
    };

    document.getElementById("clearCache").onclick = () => {
      localStorage.removeItem(CACHE_KEY);
      geoCache = {};
      setStatus("Okul cache sıfırlandı. Konumları tekrar bulmalısın.");
      render();
    };

    document.getElementById("btnGeocodeAll").onclick = async () => {
      if (!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY.includes("YOUR_GOOGLE")) {
        setStatus("Google API key eklemen lazım: GOOGLE_MAPS_API_KEY alanını doldur.");
        return;
      }

      const visible = getFilteredSchools();
      if (visible.length === 0) return;

      setStatus("Toplu konum bulma başladı (cache varsa hızlı olur)...");
      disableTopButtons(true);

      let done = 0;
      for (const s of visible) {
        done++;
        setStatus(`(${done}/${visible.length}) Konum aranıyor: ${s.name}`);

        const input = document.querySelector(`input[data-school-id="${cssEscape(s.id)}"]`);
        const q = input ? input.value.trim() : s.address;

        if (!geoCache[s.id]) {
          try {
            await geocodeSchoolIfNeeded(s, q);
          } catch (e) {
            console.error(e);
          }
          await sleep(GEOCODE_DELAY_MS);
        }
      }

      setStatus("Toplu konum bulma bitti. Liste güncellendi.");
      disableTopButtons(false);
      render();
    };

    document.getElementById("btnShowAll").onclick = async () => {
      const visible = getFilteredSchools();
      if (visible.length === 0) return;

      setStatus("Hepsini haritada göstermek için eksikler tamamlanıyor...");
      disableTopButtons(true);

      let bounds = L.latLngBounds();
      bounds.extend([HOME_COORD.lat, HOME_COORD.lon]);

      let done = 0;
      for (const s of visible) {
        done++;
        setStatus(`(${done}/${visible.length}) Haritada: ${s.name}`);

        const input = document.querySelector(`input[data-school-id="${cssEscape(s.id)}"]`);
        const q = input ? input.value.trim() : s.address;

        let rec = geoCache[s.id];
        if (!rec) {
          try { rec = await geocodeSchoolIfNeeded(s, q); }
          catch (e) { console.error(e); rec = null; }
          await sleep(GEOCODE_DELAY_MS);
        }

        if (rec) {
          const m = L.marker([rec.lat, rec.lon]).addTo(markersLayer);
          m.bindPopup(`<b>${escapeHtml(s.name)}</b><br><small>${escapeHtml(rec.display || "")}</small>`);
          bounds.extend([rec.lat, rec.lon]);
        }
      }

      map.fitBounds(bounds.pad(0.15));
      setStatus("Hepsi haritada gösterildi.");
      disableTopButtons(false);
    };

    function disableTopButtons(disabled) {
      document.getElementById("btnGeocodeAll").disabled = disabled;
      document.getElementById("btnShowAll").disabled = disabled;
    }

    /***********************
     * 10) Yardımcılar
     ***********************/
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function cssEscape(value) {
      return String(value).replace(/[^a-zA-Z0-9_-]/g, ch => "\\" + ch);
    }

    /***********************
     * 11) Başlangıç
     ***********************/
    (function init(){
      setStatus("Ev konumu sabitlendi (koordinat). Okullar için 'Toplu Konum Bul' veya tek tek 'Konumu Bul' kullan.");
      render();
    })();
  </script>
</body>
</html>
