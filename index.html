<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Okullar • Evime Göre Yakınlık + Harita</title>

  <!-- Leaflet (OpenStreetMap) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --muted:#a8b3cf; --text:#e9efff; --accent:#7aa2ff; --border:#23304d; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:18px 18px 12px; border-bottom:1px solid var(--border); }
    h1 { margin:0; font-size:18px; }
    .sub { margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }

    .layout { display:grid; grid-template-columns: 460px 1fr; gap:12px; height: calc(100vh - 122px); }
    @media (max-width: 980px) { .layout { grid-template-columns: 1fr; height:auto; } #map { height: 55vh; } }

    .panel { padding:12px; overflow:auto; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin-bottom:10px; }
    .row { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .title { font-weight:700; font-size:14px; }
    .meta { color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    button { background:transparent; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600; font-size:12px; }
    button:hover { border-color: var(--accent); }
    button.primary { background: rgba(122,162,255,.12); border-color: rgba(122,162,255,.35); }
    button.danger { border-color: rgba(255,120,120,.35); background: rgba(255,120,120,.10); }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .input { width:100%; box-sizing:border-box; margin-top:10px; background:#0f1730; border:1px solid var(--border); color:var(--text); padding:9px 10px; border-radius:10px; font-size:12px; }
    .hint { margin-top:8px; color:var(--muted); font-size:12px; }
    .topbar { display:flex; gap:10px; align-items:center; margin: 12px; flex-wrap:wrap; }
    .search { flex:1; min-width: 240px; }

    #map { height:100%; width:100%; border-left:1px solid var(--border); }
    .badge { font-size:11px; color: var(--muted); border:1px solid var(--border); padding:4px 8px; border-radius:999px; white-space:nowrap; }
    .status { margin: 0 12px 12px; color: var(--muted); font-size: 12px; line-height:1.35; }
    .km { font-weight:700; color: var(--text); }
    .small { font-size:11px; color: var(--muted); margin-top: 6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>

<body>
  <header>
    <h1>Okullar (İmam Hatip Hariç) • Evime Göre Yakınlık + Harita</h1>
    <div class="sub">
      Ev konumu: <span class="mono">Feyzullah Mahallesi, Sevinç Sokak, Maltepe, İstanbul</span><br>
      “Toplu Konum Bul” ile okulların koordinatlarını bulur, sonra **yakınlığa göre sıralar** (mesafe: kuş uçuşu).
      Bulunan koordinatlar tarayıcıda cache’lenir.
    </div>
  </header>

  <div class="topbar">
    <input id="filter" class="input search" placeholder="Ara: okul adı / ilçe (örn: Maltepe, Zümrütevler, Kadıköy...)">
    <button id="btnGeocodeAll" class="primary">Toplu Konum Bul</button>
    <button id="btnShowAll" class="primary">Hepsini Haritada Göster</button>
    <button id="clearMarkers">Haritayı Temizle</button>
    <button id="clearCache" class="danger">Cache Sıfırla</button>
  </div>

  <div class="status" id="status">Hazır.</div>

  <div class="layout">
    <div class="panel" id="list"></div>
    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /***********************
     * 0) AYARLAR
     ***********************/
    const HOME_QUERY_DEFAULT = "Feyzullah Mahallesi, Sevinç Sokak, Maltepe, İstanbul";
    const CACHE_KEY = "school_geo_cache_v1";
    const HOME_CACHE_KEY = "home_geo_cache_v1";

    // Nominatim'i yormamak için istekler arasında kısa bekleme (ms)
    const GEOCODE_DELAY_MS = 900;

    /***********************
     * 1) OKUL VERİSİ (İmam Hatip olanlar çıkarıldı)
     ***********************/
    const schools = [
      // MALTEPE
      { id: "maltepe_adnan_kahveci", district: "Maltepe", name: "Adnan Kahveci Ortaokulu", address: "Adnan Kahveci Ortaokulu, Maltepe, İstanbul" },
      { id: "maltepe_celal_avsar", district: "Maltepe", name: "Celal Avşar Ortaokulu", address: "Celal Avşar Ortaokulu, Maltepe, İstanbul" },
      { id: "maltepe_kucukyali_mtal", district: "Maltepe", name: "Küçükyalı Mesleki ve Teknik Anadolu Lisesi", address: "Küçükyalı Mesleki ve Teknik Anadolu Lisesi, Maltepe, İstanbul" },
      { id: "maltepe_muhsine_zeynep", district: "Maltepe", name: "Muhsine Zeynep Ortaokulu", address: "Muhsine Zeynep Ortaokulu, Maltepe, İstanbul" },
      { id: "maltepe_mutluhan_uzunal_colakoglu", district: "Maltepe", name: "Mutluhan-Uzunal-Çolakoğlu Ortaokulu", address: "Mutluhan-Uzunal-Çolakoğlu Ortaokulu, Maltepe, İstanbul" },
      { id: "maltepe_suzan_ahmet_yalkin", district: "Maltepe", name: "Suzan Ahmet Yalkın Ortaokulu", address: "Suzan Ahmet Yalkın Ortaokulu, Maltepe, İstanbul" },
      { id: "maltepe_toki_anadolu", district: "Maltepe", name: "TOKİ Maltepe Anadolu Lisesi", address: "TOKİ Maltepe Anadolu Lisesi, Maltepe, İstanbul" },
      { id: "maltepe_zumrutevler_anadolu", district: "Maltepe", name: "Zümrütevler Anadolu Lisesi", address: "Zümrütevler Anadolu Lisesi, Maltepe, İstanbul" },

      // KADIKÖY
      { id: "kadikoy_bahariye", district: "Kadıköy", name: "Bahariye Ortaokulu", address: "Bahariye Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_bostanci_ataturk", district: "Kadıköy", name: "Bostancı Atatürk Ortaokulu", address: "Bostancı Atatürk Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_cenap_sahabettin", district: "Kadıköy", name: "Cenap Şahabettin İlkokulu", address: "Cenap Şahabettin İlkokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_faik_resit_unat", district: "Kadıköy", name: "Faik Reşit Unat Ortaokulu", address: "Faik Reşit Unat Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_halil_turkan", district: "Kadıköy", name: "Halil Türkan Ortaokulu", address: "Halil Türkan Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_ikbaliye", district: "Kadıköy", name: "İkbaliye Ortaokulu", address: "İkbaliye Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_ilhami_ertem", district: "Kadıköy", name: "İlhami Ertem Ortaokulu", address: "İlhami Ertem Ortaokulu, Kadıköy, İstanbul" },
      { id: "kadikoy_avni_akyol_gsl", district: "Kadıköy", name: "İstanbul Avni Akyol Güzel Sanatlar Lisesi", address: "İstanbul Avni Akyol Güzel Sanatlar Lisesi, Kadıköy, İstanbul" },
      { id: "kadikoy_spor_lisesi", district: "Kadıköy", name: "Kadıköy Spor Lisesi", address: "Kadıköy Spor Lisesi, Kadıköy, İstanbul" },
      { id: "kadikoy_resat_nuri", district: "Kadıköy", name: "Reşat Nuri Güntekin Ortaokulu", address: "Reşat Nuri Güntekin Ortaokulu, Kadıköy, İstanbul" },

      // KARTAL (İmam Hatip olmayanlar)
      { id: "kartal_100yil_ali_riza", district: "Kartal", name: "100 Yıl Ali Rıza Efendi Ortaokulu", address: "100 Yıl Ali Rıza Efendi Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_cevizli", district: "Kartal", name: "Cevizli Ortaokulu", address: "Cevizli Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_cavusoglu", district: "Kartal", name: "Çavuşoğlu Ortaokulu", address: "Çavuşoğlu Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_ibrahim_saime_zipkin", district: "Kartal", name: "İbrahim Saime Zıpkın İlkokulu", address: "İbrahim Saime Zıpkın İlkokulu, Kartal, İstanbul" },
      { id: "kartal_ihsan_zakiroglu", district: "Kartal", name: "İhsan Zakiroğlu Ortaokulu", address: "İhsan Zakiroğlu Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_borsa_istanbul_mtal", district: "Kartal", name: "Kartal Borsa İstanbul Mesleki ve Teknik Anadolu Lisesi", address: "Kartal Borsa İstanbul Mesleki ve Teknik Anadolu Lisesi, Kartal, İstanbul" },
      { id: "kartal_mev_ortaokulu", district: "Kartal", name: "Kartal Milli Eğitim Vakfı Ortaokulu", address: "Kartal Milli Eğitim Vakfı Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_sehit_er_serhat_sanli", district: "Kartal", name: "Şehit Er Serhat Şanlı Ortaokulu", address: "Şehit Er Serhat Şanlı Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_sehit_timur_aktemur", district: "Kartal", name: "Şehit Timur Aktemur Ortaokulu", address: "Şehit Timur Aktemur Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_toki_sehit_mustafa", district: "Kartal", name: "TOKİ Şehit Mustafa Kartal Ortaokulu", address: "TOKİ Şehit Mustafa Kartal Ortaokulu, Kartal, İstanbul" },
      { id: "kartal_ulku_bora", district: "Kartal", name: "Ülkü Bora Ortaokulu", address: "Ülkü Bora Ortaokulu, Kartal, İstanbul" },

      // PENDİK (İmam Hatip olmayanlar)
      { id: "pendik_700_yil", district: "Pendik", name: "700. Yıl Ortaokulu", address: "700. Yıl Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_abdullah_acar", district: "Pendik", name: "Abdullah Acar Ortaokulu", address: "Abdullah Acar Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_alparslan_al", district: "Pendik", name: "Alparslan Anadolu Lisesi", address: "Alparslan Anadolu Lisesi, Pendik, İstanbul" },
      { id: "pendik_cahit_zarifoglu", district: "Pendik", name: "Cahit Zarifoğlu Ortaokulu", address: "Cahit Zarifoğlu Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_faruk_demirbag", district: "Pendik", name: "Faruk Demirbağ Ortaokulu", address: "Faruk Demirbağ Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_kazim_karabekir", district: "Pendik", name: "Kazım Karabekir Ortaokulu", address: "Kazım Karabekir Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_mehmet_akif_ersoy", district: "Pendik", name: "Mehmet Akif Ersoy Ortaokulu", address: "Mehmet Akif Ersoy Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_nuri_demirag_mtal", district: "Pendik", name: "Nuri Demirağ Mesleki ve Teknik Anadolu Lisesi", address: "Nuri Demirağ Mesleki ve Teknik Anadolu Lisesi, Pendik, İstanbul" },
      { id: "pendik_orhangazi", district: "Pendik", name: "Orhangazi Ortaokulu", address: "Orhangazi Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_ogretmenevleri", district: "Pendik", name: "Öğretmenevleri Ortaokulu", address: "Öğretmenevleri Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_sehit_selcuk_beki", district: "Pendik", name: "Şehit Selçuk Beki Ortaokulu", address: "Şehit Selçuk Beki Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_seyhli", district: "Pendik", name: "Şeyhli Ortaokulu", address: "Şeyhli Ortaokulu, Pendik, İstanbul" },
      { id: "pendik_velibaba", district: "Pendik", name: "Velibaba Ortaokulu", address: "Velibaba Ortaokulu, Pendik, İstanbul" },
    ];

    /***********************
     * 2) CACHE YÖNETİMİ
     ***********************/
    function loadCache(key) {
      try { return JSON.parse(localStorage.getItem(key) || "{}"); }
      catch { return {}; }
    }
    function saveCache(key, obj) {
      localStorage.setItem(key, JSON.stringify(obj));
    }

    let geoCache = loadCache(CACHE_KEY);     // { [schoolId]: {lat, lon, display, query, ts} }
    let homeCache = loadCache(HOME_CACHE_KEY); // { lat, lon, display, query, ts } veya {}

    /***********************
     * 3) HARİTA KURULUMU
     ***********************/
    const map = L.map("map", { zoomControl: true }).setView([40.935, 29.135], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap katkıcıları'
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);
    let homeMarker = null;

    /***********************
     * 4) GEOCODING (Nominatim)
     ***********************/
    async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    async function geocode(query) {
      const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(query);
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("Geocoding isteği başarısız: " + res.status);
      const data = await res.json();
      if (!data || data.length === 0) return null;
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), display: data[0].display_name };
    }

    function setStatus(text) {
      document.getElementById("status").textContent = text;
    }

    /***********************
     * 5) MESAFE HESABI (Haversine)
     ***********************/
    function toRad(x) { return x * Math.PI / 180; }

    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371; // km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    /***********************
     * 6) EV KONUMUNU HAZIRLA
     ***********************/
    const homeInputDefault = HOME_QUERY_DEFAULT;

    async function ensureHomeGeocoded() {
      if (homeCache && typeof homeCache.lat === "number" && typeof homeCache.lon === "number") {
        placeHomeMarker(homeCache.lat, homeCache.lon, homeCache.display || homeInputDefault);
        return true;
      }

      setStatus("Ev konumu aranıyor (ilk kurulum): " + homeInputDefault);
      const found = await geocode(homeInputDefault);
      if (!found) {
        setStatus("Ev konumu bulunamadı. Lütfen adresi daha detaylı yazın.");
        return false;
      }

      homeCache = { ...found, query: homeInputDefault, ts: Date.now() };
      saveCache(HOME_CACHE_KEY, homeCache);
      placeHomeMarker(found.lat, found.lon, found.display);
      setStatus("Ev konumu ayarlandı.");
      return true;
    }

    function placeHomeMarker(lat, lon, displayName) {
      if (homeMarker) markersLayer.removeLayer(homeMarker);
      homeMarker = L.marker([lat, lon], { title: "Ev Konumu" }).addTo(markersLayer);
      homeMarker.bindPopup(`<b>Ev Konumu</b><br><small>${escapeHtml(displayName || homeInputDefault)}</small>`);

      map.setView([lat, lon], 13);
    }

    /***********************
     * 7) OKUL KONUMLARINI ÇEK + CACHE'LE
     ***********************/
    async function geocodeSchoolIfNeeded(school, queryOverride) {
      const existing = geoCache[school.id];
      if (existing && typeof existing.lat === "number" && typeof existing.lon === "number") return existing;

      const q = (queryOverride || school.address || `${school.name}, ${school.district}, İstanbul`).trim();
      const found = await geocode(q);
      if (!found) return null;

      const rec = { ...found, query: q, ts: Date.now() };
      geoCache[school.id] = rec;
      saveCache(CACHE_KEY, geoCache);
      return rec;
    }

    async function geocodeAllVisibleSchools() {
      const visible = getFilteredSchools();
      if (visible.length === 0) return;

      const ok = await ensureHomeGeocoded();
      if (!ok) return;

      let done = 0;
      for (const s of visible) {
        done++;
        setStatus(`Konum bulunuyor: (${done}/${visible.length}) ${s.name}`);
        try {
          // kart üzerindeki input'tan daha detaylı adres yazıldıysa onu kullanacağız
          const input = document.querySelector(`input[data-school-id="${cssEscape(s.id)}"]`);
          const q = input ? input.value.trim() : s.address;

          const r = await geocodeSchoolIfNeeded(s, q);
          if (!r) {
            // bulunamadıysa geç
          }
        } catch (e) {
          console.error(e);
        }
        await sleep(GEOCODE_DELAY_MS);
      }

      setStatus("Toplu konum bulma bitti. Liste yakınlığa göre güncellendi.");
      render(); // mesafe hesapla + sırala
    }

    /***********************
     * 8) HARİTAYA MARKER EKLE
     ***********************/
    function addSchoolMarker(school, rec) {
      const marker = L.marker([rec.lat, rec.lon]).addTo(markersLayer);
      const kmText = homeCache && homeCache.lat
        ? `${haversineKm(homeCache.lat, homeCache.lon, rec.lat, rec.lon).toFixed(2)} km`
        : "—";

      marker.bindPopup(
        `<b>${escapeHtml(school.name)}</b><br>` +
        `<span class="badge">${escapeHtml(school.district)}</span><br>` +
        `<div style="margin-top:6px"><b>Mesafe:</b> ${escapeHtml(kmText)}</div>` +
        `<small>${escapeHtml(rec.display || "")}</small><br>` +
        `<div class="small">Arama: ${escapeHtml(rec.query || "")}</div>`
      );

      return marker;
    }

    async function showAllOnMap() {
      const ok = await ensureHomeGeocoded();
      if (!ok) return;

      const visible = getFilteredSchools();
      if (visible.length === 0) return;

      setStatus("Haritada göstermek için eksik konumlar tamamlanıyor (cache varsa hızlı olur)...");
      let bounds = L.latLngBounds();
      bounds.extend([homeCache.lat, homeCache.lon]);

      let done = 0;
      for (const s of visible) {
        done++;
        setStatus(`Haritada hazırlanıyor: (${done}/${visible.length}) ${s.name}`);

        const input = document.querySelector(`input[data-school-id="${cssEscape(s.id)}"]`);
        const q = input ? input.value.trim() : s.address;

        let rec = geoCache[s.id];
        if (!rec) {
          try {
            rec = await geocodeSchoolIfNeeded(s, q);
          } catch (e) {
            console.error(e);
            rec = null;
          }
          await sleep(GEOCODE_DELAY_MS);
        }

        if (rec) {
          addSchoolMarker(s, rec);
          bounds.extend([rec.lat, rec.lon]);
        }
      }

      map.fitBounds(bounds.pad(0.15));
      setStatus("Hepsi haritada gösterildi.");
    }

    /***********************
     * 9) LİSTE: FILTER + SIRALAMA (yakınlık)
     ***********************/
    const listEl = document.getElementById("list");
    const filterEl = document.getElementById("filter");

    function getFilteredSchools() {
      const q = (filterEl.value || "").toLowerCase().trim();
      return schools.filter(s => {
        const hay = (s.name + " " + s.district).toLowerCase();
        return !q || hay.includes(q);
      });
    }

    function computeDistanceForSchool(s) {
      const rec = geoCache[s.id];
      if (!homeCache || typeof homeCache.lat !== "number" || typeof homeCache.lon !== "number") return null;
      if (!rec || typeof rec.lat !== "number" || typeof rec.lon !== "number") return null;
      return haversineKm(homeCache.lat, homeCache.lon, rec.lat, rec.lon);
    }

    function createSchoolCard(s) {
      const card = document.createElement("div");
      card.className = "card";

      const distKm = computeDistanceForSchool(s);
      const distLabel = (typeof distKm === "number") ? `${distKm.toFixed(2)} km` : "—";

      const top = document.createElement("div");
      top.className = "row";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="title">${escapeHtml(s.name)}</div>
        <div class="meta">
          <span class="badge">${escapeHtml(s.district)}</span>
          <span class="badge">Mesafe: <span class="km">${escapeHtml(distLabel)}</span></span>
        </div>
      `;

      const right = document.createElement("div");
      right.innerHTML = `<span class="badge">OSM</span>`;

      top.appendChild(left);
      top.appendChild(right);

      const addrInput = document.createElement("input");
      addrInput.className = "input";
      addrInput.value = (s.address || `${s.name}, ${s.district}, İstanbul`);
      addrInput.placeholder = "Konum/Adres (mahalle/sokak ekleyebilirsiniz)";
      addrInput.setAttribute("data-school-id", s.id);

      const controls = document.createElement("div");
      controls.className = "controls";

      const btnFind = document.createElement("button");
      btnFind.className = "primary";
      btnFind.textContent = "Konumu Bul & Mesafeyi Hesapla";

      const btnShow = document.createElement("button");
      btnShow.textContent = "Haritada Göster";

      const btnCopy = document.createElement("button");
      btnCopy.textContent = "Arama Metnini Kopyala";

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "İpucu: Mahalle/Sokak eklerseniz daha doğru sonuç çıkar.";

      btnCopy.onclick = async () => {
        try {
          await navigator.clipboard.writeText(addrInput.value);
          setStatus("Kopyalandı: " + addrInput.value);
        } catch {
          setStatus("Kopyalama başarısız. Tarayıcı izin vermedi.");
        }
      };

      btnFind.onclick = async () => {
        const ok = await ensureHomeGeocoded();
        if (!ok) return;

        const q = addrInput.value.trim();
        if (!q) return;

        setStatus("Konum aranıyor: " + q);
        btnFind.disabled = true;
        btnFind.textContent = "Aranıyor...";

        try {
          // cache yoksa geocode et
          const rec = await geocodeSchoolIfNeeded(s, q);
          if (!rec) {
            setStatus("Konum bulunamadı. Adresi daha detaylı yazıp tekrar deneyin.");
            return;
          }

          const km = haversineKm(homeCache.lat, homeCache.lon, rec.lat, rec.lon);
          setStatus(`${s.name} bulundu. Mesafe: ${km.toFixed(2)} km`);

          // Listeyi yeniden sırala
          render();
        } catch (e) {
          console.error(e);
          setStatus("Hata: Konum aranırken sorun oldu. İnternet bağlantısını kontrol edin.");
        } finally {
          btnFind.disabled = false;
          btnFind.textContent = "Konumu Bul & Mesafeyi Hesapla";
        }
      };

      btnShow.onclick = async () => {
        const ok = await ensureHomeGeocoded();
        if (!ok) return;

        const q = addrInput.value.trim();
        if (!q) return;

        setStatus("Haritada göstermek için konum aranıyor: " + q);
        btnShow.disabled = true;
        btnShow.textContent = "Aranıyor...";

        try {
          let rec = geoCache[s.id];
          if (!rec) rec = await geocodeSchoolIfNeeded(s, q);

          if (!rec) {
            setStatus("Konum bulunamadı. Adresi daha detaylı yazıp tekrar deneyin.");
            return;
          }

          const marker = addSchoolMarker(s, rec);
          marker.openPopup();

          const bounds = L.latLngBounds();
          bounds.extend([homeCache.lat, homeCache.lon]);
          bounds.extend([rec.lat, rec.lon]);
          map.fitBounds(bounds.pad(0.25));

          setStatus("Haritada gösterildi: " + s.name);
        } catch (e) {
          console.error(e);
          setStatus("Hata: Konum aranırken sorun oldu.");
        } finally {
          btnShow.disabled = false;
          btnShow.textContent = "Haritada Göster";
        }
      };

      controls.appendChild(btnFind);
      controls.appendChild(btnShow);
      controls.appendChild(btnCopy);

      card.appendChild(top);
      card.appendChild(addrInput);
      card.appendChild(controls);
      card.appendChild(hint);

      return card;
    }

    function render() {
      const filtered = getFilteredSchools();

      // Ev konumu varsa ve bazı okulların konumu varsa => mesafeye göre sırala
      const withDistances = filtered.map(s => {
        const d = computeDistanceForSchool(s);
        return { s, d };
      });

      withDistances.sort((a, b) => {
        const ad = (typeof a.d === "number") ? a.d : Number.POSITIVE_INFINITY;
        const bd = (typeof b.d === "number") ? b.d : Number.POSITIVE_INFINITY;
        if (ad !== bd) return ad - bd;
        // mesafe yoksa alfabetik
        return a.s.name.localeCompare(b.s.name, "tr");
      });

      listEl.innerHTML = "";
      if (withDistances.length === 0) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.textContent = "Eşleşen okul bulunamadı.";
        listEl.appendChild(empty);
        return;
      }

      withDistances.forEach(({s}) => listEl.appendChild(createSchoolCard(s)));
    }

    /***********************
     * 10) UI BUTONLARI
     ***********************/
    filterEl.addEventListener("input", render);

    document.getElementById("clearMarkers").onclick = () => {
      markersLayer.clearLayers();
      homeMarker = null;
      // Ev markerını tekrar ekleyelim (cache varsa)
      if (homeCache && typeof homeCache.lat === "number") placeHomeMarker(homeCache.lat, homeCache.lon, homeCache.display);
      setStatus("Harita temizlendi.");
    };

    document.getElementById("clearCache").onclick = () => {
      localStorage.removeItem(CACHE_KEY);
      localStorage.removeItem(HOME_CACHE_KEY);
      geoCache = {};
      homeCache = {};
      markersLayer.clearLayers();
      homeMarker = null;
      setStatus("Cache sıfırlandı. (Konumları tekrar bulmanız gerekecek.)");
      render();
    };

    document.getElementById("btnGeocodeAll").onclick = async () => {
      disableTopButtons(true);
      try {
        await geocodeAllVisibleSchools();
      } finally {
        disableTopButtons(false);
      }
    };

    document.getElementById("btnShowAll").onclick = async () => {
      disableTopButtons(true);
      try {
        await showAllOnMap();
      } finally {
        disableTopButtons(false);
      }
    };

    function disableTopButtons(disabled) {
      document.getElementById("btnGeocodeAll").disabled = disabled;
      document.getElementById("btnShowAll").disabled = disabled;
    }

    /***********************
     * 11) Yardımcılar
     ***********************/
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // CSS selector için güvenli kaçış (id içinde underscore var ama garanti olsun)
    function cssEscape(value) {
      // Basit kaçış: özel karakterleri backslash ile
      return String(value).replace(/[^a-zA-Z0-9_-]/g, ch => "\\" + ch);
    }

    /***********************
     * 12) Başlangıç
     ***********************/
    (async function init() {
      // Ev konumunu mümkünse hemen kur
      try {
        await ensureHomeGeocoded();
      } catch (e) {
        console.error(e);
      }
      render();
    })();
  </script>
</body>
</html>
