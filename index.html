<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Okullar • Konum Bul & Haritada Göster</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --muted:#a8b3cf; --text:#e9efff; --accent:#7aa2ff; --border:#23304d; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header { padding:18px 18px 12px; border-bottom:1px solid var(--border); }
    h1 { margin:0; font-size:18px; }
    .sub { margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }
    .topbar { display:flex; gap:10px; align-items:center; margin:12px; flex-wrap:wrap; }
    .input { width:100%; box-sizing:border-box; background:#0f1730; border:1px solid var(--border); color:var(--text); padding:9px 10px; border-radius:10px; font-size:12px; }
    .search { flex:1; min-width:240px; }
    button { background:transparent; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600; font-size:12px; }
    button:hover { border-color: var(--accent); }
    button.primary { background: rgba(122,162,255,.12); border-color: rgba(122,162,255,.35); }
    button.danger { border-color: rgba(255,120,120,.35); background: rgba(255,120,120,.10); }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .status { margin:0 12px 12px; color:var(--muted); font-size:12px; line-height:1.35; }

    .layout { display:grid; grid-template-columns: 520px 1fr; gap:12px; height: calc(100vh - 132px); }
    @media (max-width: 980px) { .layout { grid-template-columns: 1fr; height:auto; } #map { height: 55vh; } }
    .panel { padding:12px; overflow:auto; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin-bottom:10px; }
    .row { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .title { font-weight:700; font-size:14px; }
    .meta { color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }
    .badge { font-size:11px; color: var(--muted); border:1px solid var(--border); padding:4px 8px; border-radius:999px; white-space:nowrap; display:inline-block; margin-right:6px; margin-top:6px; }
    .km { font-weight:700; color:var(--text); }
    #map { height:100%; width:100%; border-left:1px solid var(--border); background:#0f1730; }
    .addrlabel { margin-top:10px; color:var(--muted); font-size:11px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    a { color: var(--accent); text-decoration:none; }
    a:hover { text-decoration: underline; }
  </style>
</head>

<body>
  <header>
    <h1>Okullar • Konum Bul & Haritada Göster</h1>
    <div class="sub">
      Ev koordinatı: <span class="mono">40.932218, 29.126709</span><br>
      Her okul kartında <b>Konum Bul</b> butonuna basınca okul sağdaki haritada ev ile birlikte gösterilir.
    </div>
  </header>

  <div class="topbar">
    <input id="filter" class="input search" placeholder="Ara: okul adı / ilçe (örn: Maltepe, Kadıköy...)">
    <button id="btnClearMarkers" class="primary">Haritayı Temizle</button>
    <button id="clearCache" class="danger">Cache Sıfırla</button>
  </div>

  <div class="status" id="status">Google yükleniyor...</div>

  <div class="layout">
    <div class="panel" id="list"></div>
    <div id="map"></div>
  </div>

  <script>
    /***********************
     * 1) AYARLAR
     ***********************/
    const GOOGLE_KEY = "AIzaSyDjrjb-aYP3CAFffI31Uorm2i1ICB8naUA"; // <-- buraya key
    const HOME = { lat: 40.932218, lng: 29.126709, label: "Ev" };
    const CACHE_KEY = "school_google_places_cache_btn_v1";
    const BIAS_RADIUS_M = 25000; // ev çevresinde arama bias

    /***********************
     * 2) OKULLAR (liste filtrelenmiş)
     ***********************/
    const schools = [
      // MALTEPE
      { id:"maltepe_adnan_kahveci", district:"Maltepe", name:"Adnan Kahveci Ortaokulu" },
      { id:"maltepe_celal_avsar", district:"Maltepe", name:"Celal Avşar Ortaokulu" },
      { id:"maltepe_kucukyali_mtal", district:"Maltepe", name:"Küçükyalı Mesleki ve Teknik Anadolu Lisesi" },
      { id:"maltepe_muhsine_zeynep", district:"Maltepe", name:"Muhsine Zeynep Ortaokulu" },
      { id:"maltepe_mutluhan_uzunal_colakoglu", district:"Maltepe", name:"Mutluhan-Uzunal-Çolakoğlu Ortaokulu" },
      { id:"maltepe_suzan_ahmet_yalkin", district:"Maltepe", name:"Suzan Ahmet Yalkın Ortaokulu" },
      { id:"maltepe_toki_anadolu", district:"Maltepe", name:"TOKİ Maltepe Anadolu Lisesi" },
      { id:"maltepe_zumrutevler_anadolu", district:"Maltepe", name:"Zümrütevler Anadolu Lisesi" },

      // KADIKÖY
      { id:"kadikoy_bahariye", district:"Kadıköy", name:"Bahariye Ortaokulu" },
      { id:"kadikoy_bostanci_ataturk", district:"Kadıköy", name:"Bostancı Atatürk Ortaokulu" },
      { id:"kadikoy_cenap_sahabettin", district:"Kadıköy", name:"Cenap Şahabettin İlkokulu" },
      { id:"kadikoy_faik_resit_unat", district:"Kadıköy", name:"Faik Reşit Unat Ortaokulu" },
      { id:"kadikoy_halil_turkan", district:"Kadıköy", name:"Halil Türkan Ortaokulu" },
      { id:"kadikoy_ikbaliye", district:"Kadıköy", name:"İkbaliye Ortaokulu" },
      { id:"kadikoy_ilhami_ertem", district:"Kadıköy", name:"İlhami Ertem Ortaokulu" },
      { id:"kadikoy_avni_akyol_gsl", district:"Kadıköy", name:"İstanbul Avni Akyol Güzel Sanatlar Lisesi" },
      { id:"kadikoy_spor_lisesi", district:"Kadıköy", name:"Kadıköy Spor Lisesi" },
      { id:"kadikoy_resat_nuri", district:"Kadıköy", name:"Reşat Nuri Güntekin Ortaokulu" },

      // KARTAL
      { id:"kartal_100yil_ali_riza", district:"Kartal", name:"100 Yıl Ali Rıza Efendi Ortaokulu" },
      { id:"kartal_cevizli", district:"Kartal", name:"Cevizli Ortaokulu" },
      { id:"kartal_cavusoglu", district:"Kartal", name:"Çavuşoğlu Ortaokulu" },
      { id:"kartal_ibrahim_saime_zipkin", district:"Kartal", name:"İbrahim Saime Zıpkın İlkokulu" },
      { id:"kartal_ihsan_zakiroglu", district:"Kartal", name:"İhsan Zakiroğlu Ortaokulu" },
      { id:"kartal_borsa_istanbul_mtal", district:"Kartal", name:"Kartal Borsa İstanbul Mesleki ve Teknik Anadolu Lisesi" },
      { id:"kartal_mev_ortaokulu", district:"Kartal", name:"Kartal Milli Eğitim Vakfı Ortaokulu" },
      { id:"kartal_sehit_er_serhat_sanli", district:"Kartal", name:"Şehit Er Serhat Şanlı Ortaokulu" },
      { id:"kartal_sehit_timur_aktemur", district:"Kartal", name:"Şehit Timur Aktemur Ortaokulu" },
      { id:"kartal_toki_sehit_mustafa", district:"Kartal", name:"TOKİ Şehit Mustafa Kartal Ortaokulu" },
      { id:"kartal_ulku_bora", district:"Kartal", name:"Ülkü Bora Ortaokulu" },

      // PENDİK
      { id:"pendik_700_yil", district:"Pendik", name:"700. Yıl Ortaokulu" },
      { id:"pendik_abdullah_acar", district:"Pendik", name:"Abdullah Acar Ortaokulu" },
      { id:"pendik_alparslan_al", district:"Pendik", name:"Alparslan Anadolu Lisesi" },
      { id:"pendik_cahit_zarifoglu", district:"Pendik", name:"Cahit Zarifoğlu Ortaokulu" },
      { id:"pendik_faruk_demirbag", district:"Pendik", name:"Faruk Demirbağ Ortaokulu" },
      { id:"pendik_kazim_karabekir", district:"Pendik", name:"Kazım Karabekir Ortaokulu" },
      { id:"pendik_mehmet_akif_ersoy", district:"Pendik", name:"Mehmet Akif Ersoy Ortaokulu" },
      { id:"pendik_nuri_demirag_mtal", district:"Pendik", name:"Nuri Demirağ Mesleki ve Teknik Anadolu Lisesi" },
      { id:"pendik_orhangazi", district:"Pendik", name:"Orhangazi Ortaokulu" },
      { id:"pendik_ogretmenevleri", district:"Pendik", name:"Öğretmenevleri Ortaokulu" },
      { id:"pendik_sehit_selcuk_beki", district:"Pendik", name:"Şehit Selçuk Beki Ortaokulu" },
      { id:"pendik_seyhli", district:"Pendik", name:"Şeyhli Ortaokulu" },
      { id:"pendik_velibaba", district:"Pendik", name:"Velibaba Ortaokulu" },
    ];

    /***********************
     * 3) CACHE
     ***********************/
    function loadCache() {
      try { return JSON.parse(localStorage.getItem(CACHE_KEY) || "{}"); } catch { return {}; }
    }
    function saveCache(obj) { localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); }
    let geoCache = loadCache(); // { [id]: {lat,lng,formattedAddress,query,ts} }

    /***********************
     * 4) HELPERS
     ***********************/
    const listEl = document.getElementById("list");
    const filterEl = document.getElementById("filter");
    const statusEl = document.getElementById("status");
    function setStatus(t){ statusEl.textContent = t; }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function cssEscape(value) {
      return String(value).replace(/[^a-zA-Z0-9_-]/g, ch => "\\" + ch);
    }

    function toRad(x){ return x * Math.PI / 180; }
    function haversineKm(lat1,lng1,lat2,lng2){
      const R=6371, dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function distanceKmForSchool(s){
      const rec = geoCache[s.id];
      if (!rec) return null;
      return haversineKm(HOME.lat, HOME.lng, rec.lat, rec.lng);
    }

    /***********************
     * 5) GOOGLE MAPS / PLACES
     ***********************/
    let gmap, placesService;
    let homeMarker;
    let schoolMarkers = {}; // id -> marker
    let infoWin;

    window.__initMap = function() {
      gmap = new google.maps.Map(document.getElementById("map"), {
        center: { lat: HOME.lat, lng: HOME.lng },
        zoom: 12,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
      });

      placesService = new google.maps.places.PlacesService(gmap);
      infoWin = new google.maps.InfoWindow();

      homeMarker = new google.maps.Marker({
        map: gmap,
        position: { lat: HOME.lat, lng: HOME.lng },
        title: HOME.label
      });

      setStatus("Hazır. Bir okulun kartındaki 'Konum Bul' butonuna bas.");
      render();
    };

    function placesTextSearch(query) {
      return new Promise((resolve) => {
        const req = {
          query,
          location: new google.maps.LatLng(HOME.lat, HOME.lng),
          radius: BIAS_RADIUS_M
        };
        placesService.textSearch(req, (results, status) => {
          if (status !== google.maps.places.PlacesServiceStatus.OK || !results || results.length === 0) {
            resolve(null);
            return;
          }
          resolve(results[0]);
        });
      });
    }

    function clearMapMarkers(keepHome = true) {
      for (const id of Object.keys(schoolMarkers)) {
        schoolMarkers[id].setMap(null);
        delete schoolMarkers[id];
      }
      if (!keepHome && homeMarker) {
        homeMarker.setMap(null);
        homeMarker = null;
      }
      setStatus("Harita temizlendi.");
    }

    function showHomeAndSchoolOnMap(school, rec) {
      // okul marker
      if (schoolMarkers[school.id]) {
        schoolMarkers[school.id].setPosition({ lat: rec.lat, lng: rec.lng });
      } else {
        schoolMarkers[school.id] = new google.maps.Marker({
          map: gmap,
          position: { lat: rec.lat, lng: rec.lng },
          title: school.name
        });
      }

      const km = haversineKm(HOME.lat, HOME.lng, rec.lat, rec.lng).toFixed(2);
      const html =
        `<b>${escapeHtml(school.name)}</b><br>` +
        `<small>${escapeHtml(rec.formattedAddress || "")}</small><br>` +
        `<small><b>Mesafe:</b> ${escapeHtml(km)} km</small>`;

      schoolMarkers[school.id].addListener("click", () => {
        infoWin.setContent(html);
        infoWin.open({ map: gmap, anchor: schoolMarkers[school.id] });
      });

      // bounds: ev + okul
      const bounds = new google.maps.LatLngBounds();
      bounds.extend({ lat: HOME.lat, lng: HOME.lng });
      bounds.extend({ lat: rec.lat, lng: rec.lng });
      gmap.fitBounds(bounds);

      // popup otomatik aç
      infoWin.setContent(html);
      infoWin.open({ map: gmap, anchor: schoolMarkers[school.id] });
    }

    /***********************
     * 6) RENDER
     ***********************/
    function getFilteredSchoolsSorted() {
      const q = (filterEl.value || "").toLowerCase().trim();
      const filtered = schools.filter(s => {
        const hay = (s.name + " " + s.district).toLowerCase();
        return !q || hay.includes(q);
      });

      // bulunanlar mesafeye göre, bulunmayanlar en altta
      return filtered
        .map(s => ({ s, d: distanceKmForSchool(s) }))
        .sort((a,b) => {
          const ad = (typeof a.d === "number") ? a.d : Infinity;
          const bd = (typeof b.d === "number") ? b.d : Infinity;
          if (ad !== bd) return ad - bd;
          return a.s.name.localeCompare(b.s.name, "tr");
        })
        .map(x => x.s);
    }

    function render() {
      const visible = getFilteredSchoolsSorted();
      listEl.innerHTML = "";

      if (!placesService) {
        const c = document.createElement("div");
        c.className = "card";
        c.textContent = "Google Maps yüklenmedi. Key / referrer / API enable kontrol et.";
        listEl.appendChild(c);
        return;
      }

      for (const s of visible) {
        const card = document.createElement("div");
        card.className = "card";

        const d = distanceKmForSchool(s);
        const distLabel = (typeof d === "number") ? `${d.toFixed(2)} km` : "—";

        const top = document.createElement("div");
        top.className = "row";

        const left = document.createElement("div");
        left.innerHTML = `
          <div class="title">${escapeHtml(s.name)}</div>
          <div class="meta">
            <span class="badge">${escapeHtml(s.district)}</span>
            <span class="badge">Mesafe: <span class="km">${escapeHtml(distLabel)}</span></span>
          </div>
        `;

        const right = document.createElement("div");
        right.innerHTML = `<span class="badge">Google</span>`;

        top.appendChild(left);
        top.appendChild(right);

        const addrLabel = document.createElement("div");
        addrLabel.className = "addrlabel";
        addrLabel.textContent = "Arama metni (bulamazsa burayı daha detaylı yaz):";

        const addrInput = document.createElement("input");
        addrInput.className = "input";
        addrInput.value = `${s.name}, ${s.district}, İstanbul, Türkiye`;
        addrInput.setAttribute("data-school-id", s.id);

        const controls = document.createElement("div");
        controls.className = "controls";

        const btnFind = document.createElement("button");
        btnFind.className = "primary";
        btnFind.textContent = "Konum Bul";

        const btnForget = document.createElement("button");
        btnForget.textContent = "Bu Okulu Unut";

        const rec = geoCache[s.id];
        const meta2 = document.createElement("div");
        meta2.className = "meta";
        meta2.style.marginTop = "10px";
        meta2.innerHTML = rec
          ? `<span class="badge">Bulundu</span> <span class="badge">${escapeHtml(rec.lat.toFixed(6))}, ${escapeHtml(rec.lng.toFixed(6))}</span>`
          : `<span class="badge">Bulunmadı</span>`;

        btnFind.onclick = async () => {
          btnFind.disabled = true;
          btnFind.textContent = "Aranıyor...";
          try {
            const query = addrInput.value.trim();
            if (!query) return;

            setStatus("Aranıyor: " + s.name);

            const r = await placesTextSearch(query);
            if (!r || !r.geometry || !r.geometry.location) {
              setStatus("Bulunamadı. Arama metnini daha detaylı yazıp tekrar dene.");
              return;
            }

            const found = {
              lat: r.geometry.location.lat(),
              lng: r.geometry.location.lng(),
              formattedAddress: r.formatted_address || "",
              query,
              ts: Date.now()
            };

            geoCache[s.id] = found;
            saveCache(geoCache);

            // Haritada ev + okul göster
            showHomeAndSchoolOnMap(s, found);

            // Listeyi mesafeye göre tekrar sırala & “Bulundu” etiketini güncelle
            render();
            setStatus("Gösterildi: " + s.name);
          } catch (e) {
            console.error(e);
            setStatus("Hata oldu. Console'a (F12) bak.");
          } finally {
            btnFind.disabled = false;
            btnFind.textContent = "Konum Bul";
          }
        };

        btnForget.onclick = () => {
          delete geoCache[s.id];
          saveCache(geoCache);
          setStatus("Unutuldu: " + s.name);
          render();
        };

        controls.appendChild(btnFind);
        controls.appendChild(btnForget);

        card.appendChild(top);
        card.appendChild(addrLabel);
        card.appendChild(addrInput);
        card.appendChild(controls);
        card.appendChild(meta2);
        listEl.appendChild(card);
      }
    }

    /***********************
     * 7) TOP BAR
     ***********************/
    filterEl.addEventListener("input", render);

    document.getElementById("btnClearMarkers").onclick = () => {
      clearMapMarkers(true);
      // ev marker dursun; gerekirse merkeze dön
      if (gmap) gmap.setCenter({ lat: HOME.lat, lng: HOME.lng });
      if (gmap) gmap.setZoom(12);
    };

    document.getElementById("clearCache").onclick = () => {
      localStorage.removeItem(CACHE_KEY);
      geoCache = {};
      clearMapMarkers(true);
      setStatus("Cache sıfırlandı.");
      render();
    };

    /***********************
     * 8) GOOGLE SCRIPT LOADER
     ***********************/
    function loadGoogleScript() {
      if (!GOOGLE_KEY || GOOGLE_KEY === "PUT_YOUR_KEY_HERE") {
        setStatus("API key yok. GOOGLE_KEY satırına key’ini yapıştır.");
        return;
      }
      const s = document.createElement("script");
      s.async = true;
      s.defer = true;
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&libraries=places&callback=__initMap`;
      s.onerror = () => setStatus("Google Maps yüklenemedi. Key / referrer / API enable kontrol et.");
      document.head.appendChild(s);
    }

    // Başlat
    loadGoogleScript();
  </script>
</body>
</html>
