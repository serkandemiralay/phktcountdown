<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Okullar ‚Ä¢ Konum Bul & Haritada G√∂ster</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --muted:#a8b3cf; --text:#e9efff; --accent:#7aa2ff; --border:#23304d; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header { padding:18px 18px 12px; border-bottom:1px solid var(--border); }
    h1 { margin:0; font-size:18px; }
    .sub { margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }

    .topbar { display:flex; gap:10px; align-items:center; margin:12px; flex-wrap:wrap; }
    .input { width:100%; box-sizing:border-box; background:#0f1730; border:1px solid var(--border); color:var(--text); padding:9px 10px; border-radius:10px; font-size:12px; }
    .search { flex:1; min-width:240px; }
    .select { width:auto; min-width:180px; }

    button { background:transparent; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600; font-size:12px; }
    button:hover { border-color: var(--accent); }
    button.primary { background: rgba(122,162,255,.12); border-color: rgba(122,162,255,.35); }
    button.danger { border-color: rgba(255,120,120,.35); background: rgba(255,120,120,.10); }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .status { margin:0 12px 12px; color:var(--muted); font-size:12px; line-height:1.35; }

    .layout { display:grid; grid-template-columns: 520px 1fr; gap:12px; height: calc(100vh - 132px); }
    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; height:auto; }
      #map { height: 45vh; }
      #directionsPanel { max-height: 35vh; }
    }

    .panel { padding:12px; overflow:auto; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin-bottom:10px; }
    .row { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .title { font-weight:700; font-size:14px; }
    .meta { color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }
    .badge { font-size:11px; color: var(--muted); border:1px solid var(--border); padding:4px 8px; border-radius:999px; white-space:nowrap; display:inline-block; margin-right:6px; margin-top:6px; }
    .km { font-weight:700; color:var(--text); }

    .mapcol { display:flex; flex-direction:column; height:100%; border-left:1px solid var(--border); }
    #map { flex: 1 1 auto; width:100%; background:#0f1730; }
    #directionsPanel {
      flex: 0 0 auto;
      max-height: 42%;
      overflow:auto;
      background: #0f1730;
      border-top:1px solid var(--border);
      padding:10px 12px;
      color: var(--text);
      font-size:12px;
      line-height: 1.45;
    }
    #directionsPanel:empty::before {
      content: "Yol tarifi burada g√∂r√ºnecek (bir okul i√ßin Konum Bul veya Rota butonlarƒ±).";
      color: var(--muted);
    }

    .addrlabel { margin-top:10px; color:var(--muted); font-size:11px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    /* === Directions Panel okunabilirlik fix (Google adp*) === */
    #directionsPanel { background: #0f1730; color: #e9efff; }
    #directionsPanel .adp,
    #directionsPanel .adp table,
    #directionsPanel .adp-list,
    #directionsPanel .adp-summary,
    #directionsPanel .adp-substep,
    #directionsPanel .adp-text,
    #directionsPanel .adp-directions,
    #directionsPanel .adp-legal {
      color: #e9efff !important;
    }
    #directionsPanel table,
    #directionsPanel .adp table {
      background: transparent !important;
      border-color: #23304d !important;
    }
    #directionsPanel td,
    #directionsPanel th,
    #directionsPanel .adp td,
    #directionsPanel .adp th {
      color: #e9efff !important;
      border-color: #23304d !important;
    }
    #directionsPanel a,
    #directionsPanel a:visited { color: #7aa2ff !important; }
    #directionsPanel .adp-legal,
    #directionsPanel .adp-summary,
    #directionsPanel .adp-text { opacity: 0.95; }
    #directionsPanel .adp,
    #directionsPanel .adp-warnbox,
    #directionsPanel .adp-directions { background: transparent !important; }
    #directionsPanel img { filter: brightness(1.3) contrast(1.1); }
    #directionsPanel .adp-step, #directionsPanel .adp-substep { padding: 6px 0; }

    /* === InfoWindow (okul balonu) okunabilirlik === */
    .gm-style .gm-style-iw-c{
      padding:0 !important;
      border-radius:14px !important;
      background:transparent !important;
      box-shadow:0 10px 26px rgba(0,0,0,.45) !important;
    }
    .gm-style .gm-style-iw-d{ overflow:hidden !important; }
    .iwCard{
      background: rgba(11,18,32,.96);
      color:#e9efff;
      border:1px solid rgba(35,48,77,.9);
      border-radius:14px;
      padding:12px 12px;
      min-width:240px;
      max-width:320px;
      line-height:1.45;
    }
    .iwTitle{ font-weight:800; font-size:14px; margin-bottom:6px; }
    .iwMeta{ color:#a8b3cf; font-size:12px; }
    .iwRow{ margin-top:8px; font-size:12px; }
  </style>
</head>

<body>
  <header>
    <h1>Okullar ‚Ä¢ Konum Bul & Haritada G√∂ster</h1>
    <div class="sub">
      Ev koordinatƒ±: <span class="mono">40.932218, 29.126709</span><br>
      <b>Konum Bul</b> ‚Üí okul bulunur, <b>üöó Ara√ß + üöå Toplu ta≈üƒ±ma s√ºreleri</b> hesaplanƒ±r.
      <br>Rota √ßizimi ve <b>adƒ±m adƒ±m yol tarifi</b> saƒü altta g√∂sterilir.
    </div>
  </header>

  <div class="topbar">
    <select id="districtSelect" class="input select">
      <option value="">T√ºm√º</option>
    </select>

    <input id="filter" class="input search" placeholder="Ara: okul adƒ± / il√ße (√∂rn: Maltepe, Kadƒ±k√∂y...)">
    <button id="btnClearMarkers" class="primary">Haritayƒ± Temizle</button>
    <button id="clearCache" class="danger">Cache Sƒ±fƒ±rla</button>
  </div>

  <div class="status" id="status">Google y√ºkleniyor...</div>

  <div class="layout">
    <div class="panel" id="list"></div>

    <div class="mapcol">
      <div id="map"></div>
      <div id="directionsPanel"></div>
    </div>
  </div>

  <script>
    /***********************
     * 1) AYARLAR
     ***********************/
    const GOOGLE_KEY = "AIzaSyDjrjb-aYP3CAFffI31Uorm2i1ICB8naUA"; // <-- buraya key
    const HOME = { lat: 40.932218, lng: 29.126709, label: "Ev" };
    const CACHE_KEY = "school_google_places_cache_btn_v6";
    const BIAS_RADIUS_M = 25000;

    /***********************
     * 2) OKULLAR
     ***********************/
    const schools = [
      // MALTEPE
      { id:"maltepe_adnan_kahveci", district:"Maltepe", name:"Adnan Kahveci Ortaokulu" },
      { id:"maltepe_celal_avsar", district:"Maltepe", name:"Celal Av≈üar Ortaokulu" },
      { id:"maltepe_kucukyali_mtal", district:"Maltepe", name:"K√º√ß√ºkyalƒ± Mesleki ve Teknik Anadolu Lisesi" },
      { id:"maltepe_muhsine_zeynep", district:"Maltepe", name:"Muhsine Zeynep Ortaokulu" },
      { id:"maltepe_mutluhan_uzunal_colakoglu", district:"Maltepe", name:"Mutluhan-Uzunal-√áolakoƒülu Ortaokulu" },
      { id:"maltepe_suzan_ahmet_yalkin", district:"Maltepe", name:"Suzan Ahmet Yalkƒ±n Ortaokulu" },
      { id:"maltepe_toki_anadolu", district:"Maltepe", name:"TOKƒ∞ Maltepe Anadolu Lisesi" },
      { id:"maltepe_zumrutevler_anadolu", district:"Maltepe", name:"Z√ºmr√ºtevler Anadolu Lisesi" },

      // KADIK√ñY
      { id:"kadikoy_bahariye", district:"Kadƒ±k√∂y", name:"Bahariye Ortaokulu" },
      { id:"kadikoy_bostanci_ataturk", district:"Kadƒ±k√∂y", name:"Bostancƒ± Atat√ºrk Ortaokulu" },
      { id:"kadikoy_cenap_sahabettin", district:"Kadƒ±k√∂y", name:"Cenap ≈ûahabettin ƒ∞lkokulu" },
      { id:"kadikoy_faik_resit_unat", district:"Kadƒ±k√∂y", name:"Faik Re≈üit Unat Ortaokulu" },
      { id:"kadikoy_halil_turkan", district:"Kadƒ±k√∂y", name:"Halil T√ºrkan Ortaokulu" },
      { id:"kadikoy_ikbaliye", district:"Kadƒ±k√∂y", name:"ƒ∞kbaliye Ortaokulu" },
      { id:"kadikoy_ilhami_ertem", district:"Kadƒ±k√∂y", name:"ƒ∞lhami Ertem Ortaokulu" },
      { id:"kadikoy_avni_akyol_gsl", district:"Kadƒ±k√∂y", name:"ƒ∞stanbul Avni Akyol G√ºzel Sanatlar Lisesi" },
      { id:"kadikoy_spor_lisesi", district:"Kadƒ±k√∂y", name:"Kadƒ±k√∂y Spor Lisesi" },
      { id:"kadikoy_resat_nuri", district:"Kadƒ±k√∂y", name:"Re≈üat Nuri G√ºntekin Ortaokulu" },

      // KARTAL
      { id:"kartal_100yil_ali_riza", district:"Kartal", name:"100 Yƒ±l Ali Rƒ±za Efendi Ortaokulu" },
      { id:"kartal_cevizli", district:"Kartal", name:"Cevizli Ortaokulu" },
      { id:"kartal_cavusoglu", district:"Kartal", name:"√áavu≈üoƒülu Ortaokulu" },
      { id:"kartal_ibrahim_saime_zipkin", district:"Kartal", name:"ƒ∞brahim Saime Zƒ±pkƒ±n ƒ∞lkokulu" },
      { id:"kartal_ihsan_zakiroglu", district:"Kartal", name:"ƒ∞hsan Zakiroƒülu Ortaokulu" },
      { id:"kartal_borsa_istanbul_mtal", district:"Kartal", name:"Kartal Borsa ƒ∞stanbul Mesleki ve Teknik Anadolu Lisesi" },
      { id:"kartal_mev_ortaokulu", district:"Kartal", name:"Kartal Milli Eƒüitim Vakfƒ± Ortaokulu" },
      { id:"kartal_sehit_er_serhat_sanli", district:"Kartal", name:"≈ûehit Er Serhat ≈ûanlƒ± Ortaokulu" },
      { id:"kartal_sehit_timur_aktemur", district:"Kartal", name:"≈ûehit Timur Aktemur Ortaokulu" },
      { id:"kartal_toki_sehit_mustafa", district:"Kartal", name:"TOKƒ∞ ≈ûehit Mustafa Kartal Ortaokulu" },
      { id:"kartal_ulku_bora", district:"Kartal", name:"√úlk√º Bora Ortaokulu" },

      // PENDƒ∞K
      { id:"pendik_700_yil", district:"Pendik", name:"700. Yƒ±l Ortaokulu" },
      { id:"pendik_abdullah_acar", district:"Pendik", name:"Abdullah Acar Ortaokulu" },
      { id:"pendik_alparslan_al", district:"Pendik", name:"Alparslan Anadolu Lisesi" },
      { id:"pendik_cahit_zarifoglu", district:"Pendik", name:"Cahit Zarifoƒülu Ortaokulu" },
      { id:"pendik_faruk_demirbag", district:"Pendik", name:"Faruk Demirbaƒü Ortaokulu" },
      { id:"pendik_kazim_karabekir", district:"Pendik", name:"Kazƒ±m Karabekir Ortaokulu" },
      { id:"pendik_mehmet_akif_ersoy", district:"Pendik", name:"Mehmet Akif Ersoy Ortaokulu" },
      { id:"pendik_nuri_demirag_mtal", district:"Pendik", name:"Nuri Demiraƒü Mesleki ve Teknik Anadolu Lisesi" },
      { id:"pendik_orhangazi", district:"Pendik", name:"Orhangazi Ortaokulu" },
      { id:"pendik_ogretmenevleri", district:"Pendik", name:"√ñƒüretmenevleri Ortaokulu" },
      { id:"pendik_sehit_selcuk_beki", district:"Pendik", name:"≈ûehit Sel√ßuk Beki Ortaokulu" },
      { id:"pendik_seyhli", district:"Pendik", name:"≈ûeyhli Ortaokulu" },
      { id:"pendik_velibaba", district:"Pendik", name:"Velibaba Ortaokulu" },
    ];

    /***********************
     * 3) CACHE
     ***********************/
    function loadCache() {
      try { return JSON.parse(localStorage.getItem(CACHE_KEY) || "{}"); } catch { return {}; }
    }
    function saveCache(obj) { localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); }
    let geoCache = loadCache(); // { id: {lat,lng,formattedAddress,query,ts,times:{DRIVING,TRANSIT}} }

    /***********************
     * 4) HELPERS
     ***********************/
    const listEl = document.getElementById("list");
    const filterEl = document.getElementById("filter");
    const statusEl = document.getElementById("status");
    const districtSelectEl = document.getElementById("districtSelect");
    const directionsPanelEl = document.getElementById("directionsPanel");

    let currentRouteSchoolId = null;
    let currentRouteMode = null;

    function setStatus(t){ statusEl.textContent = t; }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function toRad(x){ return x * Math.PI / 180; }
    function haversineKm(lat1,lng1,lat2,lng2){
      const R=6371, dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function distanceKmForSchool(s){
      const rec = geoCache[s.id];
      if (!rec) return null;
      return haversineKm(HOME.lat, HOME.lng, rec.lat, rec.lng);
    }

    function initDistrictDropdown() {
      const districts = Array.from(new Set(schools.map(s => (s.district || "").trim())))
        .filter(Boolean)
        .sort((a,b) => a.localeCompare(b, "tr"));

      districtSelectEl.innerHTML =
        `<option value="">T√ºm√º</option>` +
        districts.map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join("");
    }

    function getCachedTime(rec, mode){ return rec?.times?.[mode] || null; }
    function bestTimeText(rec, mode){
      const t = getCachedTime(rec, mode);
      if (!t) return null;
      if (mode === "DRIVING" && t.trafficText) return t.trafficText;
      if (t.durationText) return t.durationText;
      return null;
    }

    function modeLabel(mode){
      return mode === "TRANSIT" ? "üöå Toplu ta≈üƒ±ma" : "üöó Ara√ß";
    }

    /***********************
     * 5) GOOGLE MAPS / PLACES / DIRECTIONS
     ***********************/
    let gmap, placesService, directionsService, directionsRenderer;
    let homeMarker;
    let schoolMarkers = {}; // id -> marker
    let infoWin;

    window.__initMap = function() {
      gmap = new google.maps.Map(document.getElementById("map"), {
        center: { lat: HOME.lat, lng: HOME.lng },
        zoom: 12,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
        /* Haritadaki arka plan yazƒ±/POI etiketlerini azalt */
        styles: [
          { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] },
          { featureType: "transit", elementType: "labels", stylers: [{ visibility: "off" }] },
          { featureType: "road", elementType: "labels.icon", stylers: [{ visibility: "off" }] }
        ]
      });

      placesService = new google.maps.places.PlacesService(gmap);
      directionsService = new google.maps.DirectionsService();

      directionsRenderer = new google.maps.DirectionsRenderer({
        map: gmap,
        panel: directionsPanelEl,
        suppressMarkers: true
      });

      infoWin = new google.maps.InfoWindow();

      homeMarker = new google.maps.Marker({
        map: gmap,
        position: { lat: HOME.lat, lng: HOME.lng },
        title: HOME.label
      });

      setStatus("Hazƒ±r. Semt se√ß + ara, sonra karttan Konum Bul.");
      render();
    };

    function placesTextSearch(query) {
      return new Promise((resolve) => {
        const req = {
          query,
          location: new google.maps.LatLng(HOME.lat, HOME.lng),
          radius: BIAS_RADIUS_M
        };
        placesService.textSearch(req, (results, status) => {
          if (status !== google.maps.places.PlacesServiceStatus.OK || !results || results.length === 0) {
            resolve(null);
            return;
          }
          resolve(results[0]);
        });
      });
    }

    function getTravelTimeTo(lat, lng, mode) {
      return new Promise((resolve) => {
        const req = {
          origin: new google.maps.LatLng(HOME.lat, HOME.lng),
          destination: new google.maps.LatLng(lat, lng),
          travelMode: google.maps.TravelMode[mode] || google.maps.TravelMode.DRIVING
        };
        if (mode === "DRIVING") req.drivingOptions = { departureTime: new Date() };
        if (mode === "TRANSIT") req.transitOptions = { departureTime: new Date() };

        directionsService.route(req, (result, status) => {
          try {
            if (status !== google.maps.DirectionsStatus.OK || !result?.routes?.[0]?.legs?.[0]) {
              resolve(null);
              return;
            }
            const leg = result.routes[0].legs[0];
            const normal = leg.duration ? { text: leg.duration.text, value: leg.duration.value } : null;
            const traffic = leg.duration_in_traffic ? { text: leg.duration_in_traffic.text, value: leg.duration_in_traffic.value } : null;

            resolve({
              durationText: normal?.text || "",
              durationSec: normal?.value ?? null,
              trafficText: (mode === "DRIVING" ? (traffic?.text || "") : ""),
              trafficSec: (mode === "DRIVING" ? (traffic?.value ?? null) : null),
              ts: Date.now()
            });
          } catch {
            resolve(null);
          }
        });
      });
    }

    function drawRoute(lat, lng, mode) {
      return new Promise((resolve) => {
        const req = {
          origin: new google.maps.LatLng(HOME.lat, HOME.lng),
          destination: new google.maps.LatLng(lat, lng),
          travelMode: google.maps.TravelMode[mode] || google.maps.TravelMode.DRIVING
        };
        if (mode === "DRIVING") req.drivingOptions = { departureTime: new Date() };
        if (mode === "TRANSIT") req.transitOptions = { departureTime: new Date() };

        directionsService.route(req, (result, status) => {
          if (status !== google.maps.DirectionsStatus.OK || !result) {
            directionsRenderer.setDirections({ routes: [] });
            directionsPanelEl.innerHTML = "";
            resolve(false);
            return;
          }
          directionsRenderer.setDirections(result);

          const bounds = new google.maps.LatLngBounds();
          bounds.extend({ lat: HOME.lat, lng: HOME.lng });
          bounds.extend({ lat, lng });
          gmap.fitBounds(bounds);

          currentRouteMode = mode;
          resolve(true);
        });
      });
    }

    function clearMapMarkers(keepHome = true) {
      for (const id of Object.keys(schoolMarkers)) {
        schoolMarkers[id].setMap(null);
        delete schoolMarkers[id];
      }
      if (!keepHome && homeMarker) {
        homeMarker.setMap(null);
        homeMarker = null;
      }
      if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
      directionsPanelEl.innerHTML = "";
      currentRouteSchoolId = null;
      currentRouteMode = null;
      setStatus("Harita + rota temizlendi.");
    }

    function showHomeAndSchoolMarker(school, rec) {
      if (schoolMarkers[school.id]) {
        schoolMarkers[school.id].setPosition({ lat: rec.lat, lng: rec.lng });
      } else {
        schoolMarkers[school.id] = new google.maps.Marker({
          map: gmap,
          position: { lat: rec.lat, lng: rec.lng },
          title: school.name
        });
      }

      const km = haversineKm(HOME.lat, HOME.lng, rec.lat, rec.lng).toFixed(2);
      const tDrive = bestTimeText(rec, "DRIVING");
      const tTransit = bestTimeText(rec, "TRANSIT");

      /* InfoWindow i√ßeriƒüini koyu opak kart yap */
      const html =
        `<div class="iwCard">` +
          `<div class="iwTitle">${escapeHtml(school.name)}</div>` +
          `<div class="iwMeta">${escapeHtml(rec.formattedAddress || "")}</div>` +
          `<div class="iwRow"><b>Mesafe:</b> ${escapeHtml(km)} km</div>` +
          ((tDrive || tTransit)
            ? `<div class="iwRow">` +
                `${tDrive ? `<b>üöó Ara√ß:</b> ‚è±Ô∏è ${escapeHtml(tDrive)} ` : ""}` +
                `${tTransit ? `&nbsp;&nbsp;<b>üöå Toplu:</b> ‚è±Ô∏è ${escapeHtml(tTransit)}` : ""}` +
              `</div>`
            : ``) +
        `</div>`;

      // aynƒ± marker'a tekrar tekrar listener eklememek i√ßin √∂nce temiz bir flag koy
      if (!schoolMarkers[school.id].__iwBound) {
        schoolMarkers[school.id].addListener("click", () => {
          const r = geoCache[school.id];
          if (!r) return;
          const km2 = haversineKm(HOME.lat, HOME.lng, r.lat, r.lng).toFixed(2);
          const td = bestTimeText(r, "DRIVING");
          const tt = bestTimeText(r, "TRANSIT");

          const html2 =
            `<div class="iwCard">` +
              `<div class="iwTitle">${escapeHtml(school.name)}</div>` +
              `<div class="iwMeta">${escapeHtml(r.formattedAddress || "")}</div>` +
              `<div class="iwRow"><b>Mesafe:</b> ${escapeHtml(km2)} km</div>` +
              ((td || tt)
                ? `<div class="iwRow">` +
                    `${td ? `<b>üöó Ara√ß:</b> ‚è±Ô∏è ${escapeHtml(td)} ` : ""}` +
                    `${tt ? `&nbsp;&nbsp;<b>üöå Toplu:</b> ‚è±Ô∏è ${escapeHtml(tt)}` : ""}` +
                  `</div>`
                : ``) +
            `</div>`;

          infoWin.setContent(html2);
          infoWin.open({ map: gmap, anchor: schoolMarkers[school.id] });
        });
        schoolMarkers[school.id].__iwBound = true;
      }

      infoWin.setContent(html);
      infoWin.open({ map: gmap, anchor: schoolMarkers[school.id] });
    }

    /***********************
     * 6) LISTE / RENDER
     ***********************/
    function getFilteredSchoolsSorted() {
      const q = (filterEl.value || "").toLowerCase().trim();
      const district = (districtSelectEl.value || "").trim();

      const filtered = schools.filter(s => {
        if (district && s.district !== district) return false;
        const hay = (s.name + " " + s.district).toLowerCase();
        return !q || hay.includes(q);
      });

      return filtered
        .map(s => ({ s, d: distanceKmForSchool(s) }))
        .sort((a,b) => {
          const ad = (typeof a.d === "number") ? a.d : Infinity;
          const bd = (typeof b.d === "number") ? b.d : Infinity;
          if (ad !== bd) return ad - bd;
          return a.s.name.localeCompare(b.s.name, "tr");
        })
        .map(x => x.s);
    }

    async function ensureTimesForSchool(school) {
      const rec = geoCache[school.id];
      if (!rec?.lat || !rec?.lng) return false;

      geoCache[school.id] = { ...rec, times: rec.times || {} };
      const base = geoCache[school.id];

      if (!getCachedTime(base, "DRIVING")?.durationText) {
        setStatus("üöó Ara√ß s√ºresi hesaplanƒ±yor: " + school.name);
        const t1 = await getTravelTimeTo(base.lat, base.lng, "DRIVING");
        if (t1) base.times.DRIVING = t1;
      }
      if (!getCachedTime(base, "TRANSIT")?.durationText) {
        setStatus("üöå Toplu ta≈üƒ±ma s√ºresi hesaplanƒ±yor: " + school.name);
        const t2 = await getTravelTimeTo(base.lat, base.lng, "TRANSIT");
        if (t2) base.times.TRANSIT = t2;
      }

      saveCache(geoCache);
      return true;
    }

    function render() {
      const visible = getFilteredSchoolsSorted();
      listEl.innerHTML = "";

      if (!placesService) {
        const c = document.createElement("div");
        c.className = "card";
        c.textContent = "Google Maps y√ºklenmedi. Key / referrer / API enable kontrol et.";
        listEl.appendChild(c);
        return;
      }

      for (const s of visible) {
        const rec = geoCache[s.id];

        const card = document.createElement("div");
        card.className = "card";

        const d = distanceKmForSchool(s);
        const distLabel = (typeof d === "number") ? `${d.toFixed(2)} km` : "‚Äî";

        const driveText = bestTimeText(rec, "DRIVING");
        const transitText = bestTimeText(rec, "TRANSIT");

        const timeBadges = `
          ${driveText ? `<span class="badge">üöó Ara√ß: <span class="km">‚è±Ô∏è ${escapeHtml(driveText)}</span></span>` : ""}
          ${transitText ? `<span class="badge">üöå Toplu: <span class="km">‚è±Ô∏è ${escapeHtml(transitText)}</span></span>` : ""}
        `;

        const top = document.createElement("div");
        top.className = "row";

        const left = document.createElement("div");
        left.innerHTML = `
          <div class="title">${escapeHtml(s.name)}</div>
          <div class="meta">
            <span class="badge">${escapeHtml(s.district)}</span>
            <span class="badge">Mesafe: <span class="km">${escapeHtml(distLabel)}</span></span>
            ${timeBadges}
          </div>
        `;

        const right = document.createElement("div");
        right.innerHTML = `<span class="badge">Google</span>`;

        top.appendChild(left);
        top.appendChild(right);

        const addrLabel = document.createElement("div");
        addrLabel.className = "addrlabel";
        addrLabel.textContent = "Arama metni (bulamazsa burayƒ± daha detaylƒ± yaz):";

        const addrInput = document.createElement("input");
        addrInput.className = "input";
        addrInput.value = `${s.name}, ${s.district}, ƒ∞stanbul, T√ºrkiye`;

        const controls = document.createElement("div");
        controls.className = "controls";

        const btnFind = document.createElement("button");
        btnFind.className = "primary";
        btnFind.textContent = "Konum Bul";

        const btnRouteDrive = document.createElement("button");
        btnRouteDrive.textContent = "Rota (Ara√ß)";

        const btnRouteTransit = document.createElement("button");
        btnRouteTransit.textContent = "Rota (Toplu)";

        const btnForget = document.createElement("button");
        btnForget.textContent = "Bu Okulu Unut";

        const hasCoords = !!(rec?.lat && rec?.lng);
        btnRouteDrive.disabled = !hasCoords;
        btnRouteTransit.disabled = !hasCoords;

        btnFind.onclick = async () => {
          btnFind.disabled = true;
          btnFind.textContent = "Aranƒ±yor...";
          try {
            const query = addrInput.value.trim();
            if (!query) return;

            setStatus("Aranƒ±yor: " + s.name);

            const r = await placesTextSearch(query);
            if (!r || !r.geometry || !r.geometry.location) {
              setStatus("Bulunamadƒ±. Arama metnini daha detaylƒ± yazƒ±p tekrar dene.");
              return;
            }

            const lat = r.geometry.location.lat();
            const lng = r.geometry.location.lng();

            const prev = geoCache[s.id] || {};
            geoCache[s.id] = {
              ...prev,
              lat,
              lng,
              formattedAddress: r.formatted_address || "",
              query,
              ts: Date.now(),
              times: prev.times || {}
            };
            saveCache(geoCache);

            await ensureTimesForSchool(s);

            showHomeAndSchoolMarker(s, geoCache[s.id]);

            currentRouteSchoolId = s.id;
            currentRouteMode = "DRIVING";
            setStatus(`Rota √ßiziliyor (${modeLabel("DRIVING")}): ${s.name}`);
            await drawRoute(lat, lng, "DRIVING");

            render();
            setStatus("G√∂sterildi: " + s.name);
          } catch (e) {
            console.error(e);
            setStatus("Hata oldu. Console'a (F12) bak.");
          } finally {
            btnFind.disabled = false;
            btnFind.textContent = "Konum Bul";
          }
        };

        btnRouteDrive.onclick = async () => {
          const r = geoCache[s.id];
          if (!r?.lat || !r?.lng) return;
          currentRouteSchoolId = s.id;
          currentRouteMode = "DRIVING";
          setStatus(`Rota √ßiziliyor (${modeLabel("DRIVING")}): ${s.name}`);
          await drawRoute(r.lat, r.lng, "DRIVING");
        };

        btnRouteTransit.onclick = async () => {
          const r = geoCache[s.id];
          if (!r?.lat || !r?.lng) return;
          currentRouteSchoolId = s.id;
          currentRouteMode = "TRANSIT";
          setStatus(`Rota √ßiziliyor (${modeLabel("TRANSIT")}): ${s.name}`);
          await drawRoute(r.lat, r.lng, "TRANSIT");
        };

        btnForget.onclick = () => {
          delete geoCache[s.id];
          saveCache(geoCache);
          if (currentRouteSchoolId === s.id) {
            if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
            directionsPanelEl.innerHTML = "";
            currentRouteSchoolId = null;
            currentRouteMode = null;
          }
          setStatus("Unutuldu: " + s.name);
          render();
        };

        controls.appendChild(btnFind);
        controls.appendChild(btnRouteDrive);
        controls.appendChild(btnRouteTransit);
        controls.appendChild(btnForget);

        const meta2 = document.createElement("div");
        meta2.className = "meta";
        meta2.style.marginTop = "10px";
        meta2.innerHTML = rec
          ? `<span class="badge">Bulundu</span> <span class="badge">${escapeHtml(rec.lat.toFixed(6))}, ${escapeHtml(rec.lng.toFixed(6))}</span>`
          : `<span class="badge">Bulunmadƒ±</span>`;

        card.appendChild(top);
        card.appendChild(addrLabel);
        card.appendChild(addrInput);
        card.appendChild(controls);
        card.appendChild(meta2);
        listEl.appendChild(card);
      }
    }

    /***********************
     * 7) TOP BAR
     ***********************/
    filterEl.addEventListener("input", render);
    districtSelectEl.addEventListener("change", render);

    document.getElementById("btnClearMarkers").onclick = () => {
      clearMapMarkers(true);
      if (gmap) gmap.setCenter({ lat: HOME.lat, lng: HOME.lng });
      if (gmap) gmap.setZoom(12);
    };

    document.getElementById("clearCache").onclick = () => {
      localStorage.removeItem(CACHE_KEY);
      geoCache = {};
      clearMapMarkers(true);
      setStatus("Cache sƒ±fƒ±rlandƒ±.");
      render();
    };

    /***********************
     * 8) GOOGLE SCRIPT LOADER
     ***********************/
    function loadGoogleScript() {
      if (!GOOGLE_KEY || GOOGLE_KEY === "PUT_YOUR_KEY_HERE") {
        setStatus("API key yok. GOOGLE_KEY satƒ±rƒ±na key‚Äôini yapƒ±≈ütƒ±r.");
        return;
      }
      const s = document.createElement("script");
      s.async = true;
      s.defer = true;
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&libraries=places&callback=__initMap`;
      s.onerror = () => setStatus("Google Maps y√ºklenemedi. Key / referrer / API enable kontrol et.");
      document.head.appendChild(s);
    }

    // Ba≈ülat
    initDistrictDropdown();
    loadGoogleScript();
  </script>
</body>
</html>
